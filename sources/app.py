import os
import pickle
import joblib
import streamlit as st
from file_checker import extract_info

try:
    if st.session_state['loadModel'] == True:
        pass
except:
    st.session_state['loadModel'] = True
    st.session_state['randomForest'] = joblib.load('./model/model.pkl')
    st.session_state['features'] = pickle.loads(open(os.path.join('model/features.pkl'), 'rb').read())

def nhan_ThongTinLienHe(email, text):
    with open(f'contacts/{email}.txt', 'wb') as file:
        file.write(text)

def kiemtra_TepTin(file):
    dulieu = extract_info(file)
    
    if dulieu != {}:
        danhsachthuoctinhtaptin = list(map(lambda x: dulieu[x],  st.session_state['features']))
        ketqua = st.session_state['randomForest'].predict([danhsachthuoctinhtaptin])[0]
    else:
        ketqua = 1
    return ketqua


st.set_page_config(
    page_title='Malware Scan', 
    layout='wide', 
    initial_sidebar_state='collapsed',
    page_icon='./images/icon_1.png'
)

st.image('./images/icon_2.png')
st.title('PHÁT TRIỂN ỨNG DỤNG PHÁT HIỆN MÃ ĐỘC XÂM NHẬP THỜI GIAN THỰC DỰA TRÊN KỸ THUẬT HỌC MÁY')

st.markdown('**NGHIÊN CỨU KHOA HỌC NĂM 2023 - NHÓM SINH VIÊN THỰC HIỆN: VĂN THỊ MƯỜI NGỌC - LÊ TRẠC TIẾN**')
st.markdown('**NGUỒN TẬP DỮ LIỆU**: *https://www.kaggle.com/competitions/malware-detection/data*')

models = st.sidebar.selectbox(
    'Chọn mô hình học máy?',
    ('RANDOM FOREST', )
)

files = st.file_uploader(
    label='Tải tệp cần kiểm tra:', 
    accept_multiple_files=True
)

if not (files is None):
    with st.spinner('Tiến hành kiểm tra ...'):
        for idx, file in enumerate(files):
            path = f'./malwares/tempFile_{idx}'
           
            open(path, 'wb').write(file.getvalue())
            legitimate = kiemtra_TepTin(path)

            if legitimate:
                result = f'File {file.name} Không phát hiện malwares.'
            else:
                result = f'File {file.name} phát hiện malwares.'

            st.write(result)

with st.expander('Liên hệ với chúng tôi'):
    with st.form(key='contact', clear_on_submit = True):
        email = st.text_input('Email liên hệ của bạn')
        text = st.text_area('Nội dung','').encode('utf-8')
        send = st.form_submit_button(label = 'Gửi')

        if send:
            nhan_ThongTinLienHe(email, text)